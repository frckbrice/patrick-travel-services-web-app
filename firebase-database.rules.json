{
  "rules": {
    ".read": "auth != null",
    ".write": "auth != null",

    "chats": {
      ".read": "auth != null",
      ".write": "auth != null",
      "$chatRoomId": {
        ".read": "auth != null && (root.child('chats/' + $chatRoomId + '/metadata/participants/clientId').val() == auth.uid || root.child('chats/' + $chatRoomId + '/metadata/participants/agentId').val() == auth.uid)",
        ".write": "auth != null && (root.child('chats/' + $chatRoomId + '/metadata/participants/clientId').val() == auth.uid || root.child('chats/' + $chatRoomId + '/metadata/participants/agentId').val() == auth.uid)",
        "messages": {
          ".read": "auth != null && (root.child('chats/' + $chatRoomId + '/metadata/participants/clientId').val() == auth.uid || root.child('chats/' + $chatRoomId + '/metadata/participants/agentId').val() == auth.uid)",
          ".write": "auth != null && (root.child('chats/' + $chatRoomId + '/metadata/participants/clientId').val() == auth.uid || root.child('chats/' + $chatRoomId + '/metadata/participants/agentId').val() == auth.uid)",
          "$messageId": {
            ".read": "auth != null && (root.child('chats/' + $chatRoomId + '/metadata/participants/clientId').val() == auth.uid || root.child('chats/' + $chatRoomId + '/metadata/participants/agentId').val() == auth.uid)",
            ".write": "auth != null && (newData.child('senderId').val() == auth.uid || (root.child('chats/' + $chatRoomId + '/metadata/participants/clientId').val() == auth.uid || root.child('chats/' + $chatRoomId + '/metadata/participants/agentId').val() == auth.uid))",
            ".validate": "newData.hasChildren(['senderId', 'senderName', 'content', 'sentAt']) && newData.child('senderId').val() == auth.uid && newData.child('content').isString()"
          }
        },
        "metadata": {
          ".read": "auth != null && (!data.exists() || data.child('participants/clientId').val() == auth.uid || data.child('participants/agentId').val() == auth.uid)",
          ".write": "auth != null && (!data.exists() || data.child('participants/clientId').val() == auth.uid || data.child('participants/agentId').val() == auth.uid)",
          ".validate": "newData.val() == null || (newData.hasChild('participants') && newData.child('participants').hasChildren(['clientId', 'clientName', 'agentId', 'agentName']))"
        }
      }
    },

    "userChats": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": "auth != null && auth.uid == $userId",
        "$chatRoomId": {
          ".read": "auth != null && auth.uid == $userId",
          ".write": "auth != null && auth.uid == $userId"
        }
      }
    },
    "presence": {
      "$userId": {
        ".read": true,
        ".write": "auth != null && auth.uid == $userId",
        ".validate": "newData.hasChildren(['userId', 'status', 'lastSeen'])"
      }
    },

    "typing": {
      "$chatRoomId": {
        ".read": "auth != null && (root.child('chats/' + $chatRoomId + '/metadata/participants/clientId').val() == auth.uid || root.child('chats/' + $chatRoomId + '/metadata/participants/agentId').val() == auth.uid)",
        "$userId": {
          ".write": "auth != null && auth.uid == $userId",
          ".validate": "newData.hasChildren(['userId', 'isTyping', 'timestamp'])"
        }
      }
    },

    "notifications": {
      "$userId": {
        ".read": "auth != null && auth.uid == $userId",
        ".write": false,
        ".indexOn": ["timestamp", "isRead"]
      }
    }
  }
}